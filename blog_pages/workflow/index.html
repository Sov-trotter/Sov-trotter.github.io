<!doctype html> <!-- Minimal Mistakes Jekyll Theme 4.16.4 by Michael Rose Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes Free for personal and commercial use under the MIT license https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE --> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/minimal-mistakes.css"> <link rel=stylesheet  href="/css/adjust.css"> <!--[if IE ]> <style> /* old IE unsupported flexbox fixes */ .greedy-nav .site-title { padding-right: 3em; } .greedy-nav button { position: absolute; top: 0; right: 0; height: 100%; } </style> <![endif]--> <title>Workflow</title> <body class=layout--single > <div class=masthead > <div class=masthead__inner-wrap > <div class=masthead__menu > <nav id=site-nav  class=greedy-nav > <a class=site-title  href="/">Arsh Sharma</a> <a class=site-subtitle  href="/">Receptive to code, klingon & 8bit music</a> <ul class=visible-links > <li class=masthead__menu-item ><a href="/assets/ResumeAug20_ArshSharma.pdf" >Resume</a> <li class=masthead__menu-item ><a href="/about/" >About Me</a> <li class=masthead__menu-item ><a href="/blog/" >Blog</a> <li class=masthead__menu-item ><a href="/menu2/" >Projects</a> <li class=masthead__menu-item ><a href="/menu3/">Contact</a> </ul> <button class="greedy-nav__toggle hidden" type=button > <span class=visually-hidden >Toggle menu</span> <div class=navicon ></div> </button> <ul class="hidden-links hidden"></ul> </nav> </div> </div> </div> <div class=initial-content > <div id=main  role=main > <div class="sidebar sticky"> <div itemscope itemtype="https://schema.org/Person"> <div class=author__avatar > <img src="/assets/minimal-mistakes/zenobia.png" alt="Arsh Sharma" itemprop=image > </div> <div class=author__content > <h3 class=author__name  itemprop=name >Arsh Sharma</h3> <p class=author__bio  itemprop=description >Probably not a commoner.</p> </div> <div class=author__urls-wrapper > <button class="btn btn--inverse">Follow</button> <ul class="author__urls social-icons"> <li itemprop=homeLocation  itemscope itemtype="https://schema.org/Place"> <i class="fas fa-fw fa-map-marker-alt" aria-hidden=true ></i> <span itemprop=name >Hamirpur, India</span> <li><a href="https://twitter.com/Sov_trotter" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden=true ></i>Twitter</a> <li><a href="https://github.com/Sov-trotter" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden=true ></i>GitHub</a> <li><a href="https://www.linkedin.com/in/sov-trotter/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden=true ></i>LinkedIn</a> </ul> </div> </div> </div> <div class=franklin-content ><h1 id=geometrybasics_support ><a href="#geometrybasics_support">GeometryBasics support</a></h1> <h2 id=wip_a_hrefhttpsgithubcomjuliageoshapefilejlpull39shapefilejl ><a href="#wip_a_hrefhttpsgithubcomjuliageoshapefilejlpull39shapefilejl">&#91;WIP&#93; <a href="https://github.com/JuliaGeo/Shapefile.jl/pull/39">Shapefile.jl</a>:</a></h2> <ul> <li><p><code>GeoInterface</code> geometry types are replaced by the meta-geometry types from <code>GeometryBasics</code></p> </ul> <pre><code class="julia hljs"><span class=hljs-keyword >const</span> Point = Point{<span class=hljs-number >2</span>, <span class=hljs-built_in >Float64</span>}

<span class=hljs-keyword >const</span> MultiPoint = typeof(MultiPointMeta(y::<span class=hljs-built_in >Float64</span>[Point(<span class=hljs-number >0</span>)], m::<span class=hljs-built_in >Float64</span>, 
                                         boundingbox=Rect(<span class=hljs-number >0.0</span>, <span class=hljs-number >0.0</span>, <span class=hljs-number >2.0</span>, <span class=hljs-number >2.0</span>))) 

<span class=hljs-comment ># and so on for other shapefile geometries</span></code></pre> <ul> <li><p>Geometry contructors:</p> </ul> <p>The construction of geometries is pretty simple and is handled well by <code>GeometryBasics</code> meta-geometry constructors, except for <code>Polygon</code> where we had to take an extra dependency to capture the case where it might have <a href="https://gist.github.com/jkrumbiegel/b82def0a3fb0a822963ec7f97278190c">multiple exterior rings</a>. <br>Thanks to <a href="https://github.com/greimel">Fabian Greimel</a>, who <a href="https://github.com/JuliaGeo/Shapefile.jl/pull/39#issuecomment-671595669">solved</a> it in no time&#33;</p> <ul> <li><p>Tabular Interface</p> </ul> <p>We put the collection of meta-geometries and the properties file <code>.dbf</code> into a <code>StructArray</code> for tablular representation. </p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> structarray(shp::Handle, dbf::DBFTables.Table)
    dbf_cols = Tables.columntable(dbf)
    meta = collect(GB.meta(s) <span class=hljs-keyword >for</span> s <span class=hljs-keyword >in</span> shp.shapes)
    meta_cols = Tables.columntable(meta)
    <span class=hljs-keyword >return</span> StructArray(Geometry = collect(GB.metafree(i) <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> shp.shapes); meta_cols..., dbf_cols...)
<span class=hljs-keyword >end</span></code></pre> <h2 id=wipa_hrefhttpsgithubcomvisrgeojsontablesjlpull3geojsontablesjl ><a href="#wipa_hrefhttpsgithubcomvisrgeojsontablesjlpull3geojsontablesjl">&#91;WIP&#93;<a href="https://github.com/visr/GeoJSONTables.jl/pull/3">GeoJSONTables.jl</a>:</a></h2> <ul> <li><p>Feature</p> </ul> <p>The package defines it&#39;s own Feature type that binds a geometry with it&#39;s properties. We went for this method rather than directly using GeometryBasics metageometry constructors to be able to support the case of heterogeneous geomtries that has been discussed below.</p> <pre><code class="julia hljs"><span class=hljs-keyword >struct</span> Feature{T, Names, Types}
    geometry::T
    properties::NamedTuple{Names, Types}
<span class=hljs-keyword >end</span></code></pre> <ul> <li><p>Methods</p> </ul> <p>Unlike <code>Shapefile.jl</code>, <code>GeoJSONTables.jl</code> follows a semi-lazy <code>JSON</code> parsing. A <code>read&#40;&#41;</code> method directly reads the raw jsonbytes into a StructArray <code>Table</code>. The <code>read&#40;&#41;</code> method has two major parts:</p> <p> 1&#41; The <code>JSON3</code> parsing:</p> <pre><code class="julia hljs">fc = JSON3.read(jsonbytes)</code></pre>
<p>    2&#41; Populating and constructing GeometryBasics features :</p>
<pre><code class="julia hljs">f = fc.features
     <span class=hljs-keyword >for</span> f <span class=hljs-keyword >in</span> jsonfeatures 
            geom = f.geometry
            prop = f.properties
            
            <span class=hljs-comment ># only properties missing</span>
            <span class=hljs-keyword >if</span> geom !== <span class=hljs-literal >nothing</span> &amp;&amp; prop === <span class=hljs-literal >nothing</span>
                Feature(geometry(geom), miss(a))
            
            <span class=hljs-comment ># only geometry missing            </span>
            <span class=hljs-keyword >elseif</span> geom === <span class=hljs-literal >nothing</span> &amp;&amp; prop !== <span class=hljs-literal >nothing</span>
                Feature(missing, prop)
            
            <span class=hljs-comment ># none missing</span>
            <span class=hljs-keyword >elseif</span> geom !== <span class=hljs-literal >nothing</span> &amp;&amp; prop !== <span class=hljs-literal >nothing</span>
                Feature(geometry(geom), prop)
            
            <span class=hljs-comment ># both missing            </span>
            <span class=hljs-keyword >elseif</span> geom === <span class=hljs-literal >nothing</span> &amp;&amp; prop === <span class=hljs-literal >nothing</span>
                Feature(missing, miss(a))
            <span class=hljs-keyword >end</span>
        <span class=hljs-keyword >end</span></code></pre>
<ul>
<li><p>Missing values</p>

</ul>
<p>The package now supports efficient handling of <code>missing</code> data. This happens right during the construction of geometries&#40;<code>GeoJSONTables.geometry</code> method that accepts a <code>JSON3.Object</code>&#41;.  In the above example you can see a <code>miss&#40;&#41;</code> method, which captures all the cases where a <code>JSON3</code> output might reult in <code>nothing</code>.</p>
<ul>
<li><p>StructArrays and Tabular interface</p>

</ul>
<p>This is the part that needed a careful design. One of the features of a <code>GeoJSON</code> format is that it allows for heterogeneous features i.e, there can be multiple geometry types in a single <code>GeoJSON</code> file. The challenge was getting the Tables interface to automatically widen to the appropriate types in case of heterogeneous features/geometries. eg: If a Feature has a <code>Point</code> type and a <code>Polygon</code> type, the type of our geometries column should automatically widen to <code>Any</code> and the Feature as <code>Feature&#123;Any, Names, Types&#125;</code>. This required defining <code>StructArrays.staticschema</code>, <code>StructArrays.createinstance</code> and <code>Base.getproperty</code> overloads to work well with our <code>Feature</code> type. The method is well documented in <a href="https://github.com/JuliaArrays/StructArrays.jl#advanced-structures-with-non-standard-data-layout">StructArrays.jl</a>.</p>
<ul>
<li><p>Lower level interface</p>

</ul>
<p>For a faster, lower level interface and greater flexibility with the data, one can directly have a <code>JSON3.Dict</code> to avoid the process of  conversion to GeometryBasics geometries and the Tables interface. Though it is not recommended if one wishes to use the data further for processing, plotting or performing spatial operations.</p>
<pre><code class="julia hljs">GeoJSONTables.JSON3.read(jsonbytes)</code></pre>
</div>

      </div> 
    </div>   

    <div class=page__footer >
      <footer>
        
        
        <div class=page__footer-copyright >&copy; Arsh Sharma. Powered by <a href="https://github.com/tlienart/Franklin.jl">Franklin</a> &amp; <a href="https://julialang.org" rel=nofollow >The Julia Language</a>.</div>
      </footer>
    </div>

    <script src="/libs/minimal-mistakes/main.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.8.2/js/all.js" integrity="sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH" crossorigin=anonymous ></script>